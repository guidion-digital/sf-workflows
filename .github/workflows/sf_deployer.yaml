name: Deploy sf-home to the <inputs.environment_name> environment

on:
  workflow_call:
    inputs:
      slack_channel:
        description: Channel to notifify about a deployment
        type: string
        required: false
        default: ''
      environment_name:
        description: GH environment holding information needed to deploy
        type: string
        required: false
        default: ''
      branch:
        description: Banch to checkout
        type: string
        required: false
        default: ${{ github.ref_name }}
      source_dir:
        description: Directory containing the source code to deploy
        type: string
        required: false
        default: src
      test_dir:
        description: Directory containing the tests
        type: string
        required: false
        default: sf_scripts
      sf_login_url:
        description: Salesforce login URL
        type: string
        required: false
      sf_username:
        description: Salesforce username
        type: string
        required: false
      sf_client_id:
        description: Salesforce consumer key
        type: string
        required: false
      jwt_key_b64:
        description: Salesforce JWT key
        type: string
        required: false
      sf_testlevel:
        description: Salesforce test level
        type: string
        required: false
      sf_target_org:
        description: Salesforce target org (used for the alias)
        type: string
        required: false
        default: default
    secrets:
      # These are needed when using organization secrets to further define which secret to passthrough, ie: SF_CLIENT_KEY_DEV
      SF_CLIENT_ID:
        description: Salesforce consumer key
        required: false
      SF_CLIENT_KEY:
        description: Salesforce consumer key
        required: false
      JWT_KEY_B64:
        description: Salesforce JWT key (base64 encoded)
        required: false
      SLACK_TOKEN:
        description: Slack token
        required: false

jobs:
  deploy:
    environment: ${{ inputs.environment_name }}
    runs-on: ubuntu-latest
    container: salesforce/cli:latest-slim
    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2
        with:
          ref: ${{ inputs.branch }}
      - name: Authenticate
        run: |
          echo "Authenticating to Salesforce org..."
          JWT_KEY_B64="${{ inputs.jwt_key_b64 || secrets.JWT_KEY_B64 || secrets.SF_CLIENT_KEY }}"
          printf '%s' "$JWT_KEY_B64" | base64 -d > jwt-key.key
          sf org login jwt \
            --instance-url "${{ inputs.sf_login_url || vars.SF_LOGIN_URL }}" \
            --username "${{ inputs.sf_username || vars.SF_USERNAME }}" \
            --client-id "${{ inputs.sf_client_id || vars.SF_CLIENT_ID || secrets.SF_CLIENT_ID }}" \
            --jwt-key-file jwt-key.key \
            --alias ${{ inputs.sf_target_org }}
          rm jwt-key.key
      - name: Get Test Classes from Test Suite
        id: get_tests
        if: ${{ (inputs.sf_testlevel || vars.SF_TESTLEVEL || '') == 'RunSpecifiedTests' }}
        run: |
          echo "Retrieving test classes from sf_scripts test suite..."
          echo "test_classes=" >> "$GITHUB_OUTPUT"
          TEST_CLASSES=$(sf data query \
            --query "SELECT Id, ApexClass.Name FROM TestSuiteMembership where ApexTestSuite.TestSuiteName = '${{ inputs.test_dir || vars.TEST_DIR }}'" \
            --use-tooling-api \
            --target-org "${{ inputs.sf_target_org }}" \
            --json | jq -r '.result.records[].ApexClass.Name' | tr '\n' ' ' | sed 's/ $//')

          if [ -n "$TEST_CLASSES" ]; then
            echo "Found test classes: $TEST_CLASSES"
            echo "test_classes=$TEST_CLASSES" >> "$GITHUB_OUTPUT"
          else
            echo "No test classes found in sf_scripts test suite"
          fi
      - name: Deploy with specified tests
        if: ${{ (inputs.sf_testlevel || vars.SF_TESTLEVEL || '') == 'RunSpecifiedTests' && steps.get_tests.outputs.test_classes != '' }}
        run: |
          echo "Deploying ${{ inputs.source_dir || vars.SOURCE_DIR }} with RunSpecifiedTests"
          echo "Running tests: ${{ steps.get_tests.outputs.test_classes }}"
          sf project deploy start \
            --source-dir "${{ inputs.source_dir || vars.SOURCE_DIR }}" \
            --test-level RunSpecifiedTests \
            --tests ${{ steps.get_tests.outputs.test_classes }} \
            --target-org "${{ inputs.sf_target_org }}" \
            --ignore-conflicts
      - name: Deploy with RunLocalTests (fallback)
        if: ${{ (inputs.sf_testlevel || vars.SF_TESTLEVEL || '') == 'RunSpecifiedTests' && steps.get_tests.outputs.test_classes == '' }}
        run: |
          echo "No test classes found in sf_scripts test suite, falling back to RunLocalTests"
          sf project deploy start \
            --source-dir "${{ inputs.source_dir || vars.SOURCE_DIR }}" \
            --test-level RunLocalTests \
            --target-org "${{ inputs.sf_target_org }}" \
            --ignore-conflicts
      - name: Deploy without tests when NoTestRun is set
        if: ${{ (inputs.sf_testlevel || vars.SF_TESTLEVEL || '') == 'NoTestRun' }}
        run: |
          echo "Deploying ${{ inputs.source_dir || vars.SOURCE_DIR }} with NoTestRun"
          sf project deploy start \
            --source-dir "${{ inputs.source_dir || vars.SOURCE_DIR }}" \
            --test-level NoTestRun \
            --target-org "${{ inputs.sf_target_org }}" \
            --ignore-conflicts
      - name: Deploy with all test when NoTestRun is not set
        if: ${{ (inputs.sf_testlevel || vars.SF_TESTLEVEL || '') == '' || (inputs.sf_testlevel || vars.SF_TESTLEVEL || '') == 'RunLocalTests' }}
        run: |
          echo "Deploying ${{ inputs.source_dir || vars.SOURCE_DIR }} with RunLocalTests"
          sf project deploy start \
            --source-dir "${{ inputs.source_dir || vars.SOURCE_DIR }}" \
            --test-level RunLocalTests \
            --target-org "${{ inputs.sf_target_org }}" \
            --ignore-conflicts

  notify:
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: Notify devs
        uses: guidion-digital/slack-notifications@v1
        with:
          slack_channel: ${{ inputs.slack_channel || vars.slack_channel || '' }}
          slack_token: ${{ secrets.SLACK_TOKEN }}
          workflow_status: ${{ needs.deploy.result }}
