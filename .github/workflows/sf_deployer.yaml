name: Deploy sf-home to the <inputs.environment_name> environment

on:
  workflow_call:
    inputs:
      slack_channel:
        description: Channel to notifify about a deployment
        type: string
        required: false
        default: ''
      environment_name:
        description: GH environment holding information needed to deploy
        type: string
        required: true
      branch:
        description: Banch to checkout
        type: string
        required: false
        default: ${{ github.ref_name }}
      source_dir:
        description: Directory containing the source code to deploy
        type: string
        required: false
        default: src
      sf_login_url:
        description: Salesforce login URL
        type: string
        required: false
      sf_username:
        description: Salesforce username
        type: string
        required: false
      sf_client_id:
        description: Salesforce consumer key
        type: string
        required: false
      jwt_key_b64:
        description: Salesforce JWT key
        type: string
        required: false
      sf_testlevel:
        description: Salesforce test level
        type: string
        required: false
      sf_target_org:
        description: Salesforce target org (used for the alias)
        type: string
        required: false
        default: default
    secrets:       
      SF_CLIENT_ID:
        description: Salesforce consumer key
        required: false
      SF_CLIENT_KEY:
        description: Salesforce consumer key
        required: false
      SLACK_TOKEN:
        description: Slack token
        required: false
    outputs:
      deploy-result:
        description: "Output from deploy GH Actions"
        value: ${{ jobs.deploy.outputs.result }}


jobs:
  deploy:
    environment: ${{ inputs.environment_name }}
    runs-on: ubuntu-latest
    outputs:
      result: ${{ steps.deploy.outputs.deploy }}
    container: salesforce/cli:latest-slim
    env:
      SF_LOGIN_URL: ${{ inputs.sf_login_url || vars.SF_LOGIN_URL }}
      SF_USERNAME: ${{ inputs.sf_username || vars.SF_USERNAME }}
      SF_CLIENT_ID: ${{ inputs.sf_client_id || secrets.SF_CLIENT_ID }}
      JWT_KEY_B64: ${{ inputs.jwt_key_b64 || secrets.JWT_KEY_B64 || secrets.SF_CLIENT_KEY }}
      SF_TESTLEVEL: ${{ inputs.sf_testlevel || vars.SF_TESTLEVEL || '' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2
        with:
          ref: ${{ inputs.branch }}
      - name: Initialize deployment result
        run: echo "DEPLOY_RESULT=not_set" >> $GITHUB_ENV
      - name: Authenticate
        run: |
          echo "Authenticating to Salesforce org..."
          echo $JWT_KEY_B64 | base64 -d > jwt-key.key
          sf org login jwt \
            --instance-url "$SF_LOGIN_URL" \
            --username "$SF_USERNAME" \
            --client-id "$SF_CLIENT_ID" \
            --jwt-key-file jwt-key.key \
            --alias ${{ inputs.sf_target_org }}
          rm jwt-key.key
      - name: Get Test Classes from Test Suite
        id: get_tests
        if: env.SF_TESTLEVEL == 'RunSpecifiedTests'
        run: |
          echo "Retrieving test classes from sf_scripts test suite..."
          TEST_CLASSES=$(sf data query \
            --query "SELECT Id, ApexClass.Name FROM TestSuiteMembership where ApexTestSuite.TestSuiteName = 'sf_scripts'" \
            --use-tooling-api \
            --target-org "${{ inputs.sf_target_org }}" \
            --json | jq -r '.result.records[].ApexClass.Name' | tr '\n' ' ' | sed 's/ $//')

          echo "Found test classes: ${TEST_CLASSES:-<none>}"
          echo "test_classes=$TEST_CLASSES" >> $GITHUB_OUTPUT
      - name: Deploy with specified tests
        if: env.SF_TESTLEVEL == 'RunSpecifiedTests' && steps.get_tests.outputs.test_classes != ''
        run: |
          echo "Deploying ${{ inputs.source_dir }} with specified tests"
          sf project deploy start \
            --source-dir "${{ inputs.source_dir }}" \
            --test-level RunSpecifiedTests \
            --tests "${{ steps.get_tests.outputs.test_classes }}" \
            --target-org "${{ inputs.sf_target_org }}" \
            --ignore-conflicts
          echo "DEPLOY_RESULT=RunSpecifiedTests" >> $GITHUB_ENV
      - name: Deploy without tests (no suite tests found)
        if: env.SF_TESTLEVEL == 'RunSpecifiedTests' && steps.get_tests.outputs.test_classes == ''
        run: |
          echo "No test classes found in sf_scripts test suite, falling back to NoTestRun"
          sf project deploy start \
            --source-dir "${{ inputs.source_dir }}" \
            --test-level NoTestRun \
            --target-org "${{ inputs.sf_target_org }}" \
            --ignore-conflicts
          echo "DEPLOY_RESULT=RunSpecifiedTestsFallback" >> $GITHUB_ENV
      - name: Deploy with custom test level
        if: env.SF_TESTLEVEL != '' && env.SF_TESTLEVEL != 'RunSpecifiedTests'
        run: |
          echo "Deploying ${{ inputs.source_dir }} with custom test level '$SF_TESTLEVEL'"
          sf project deploy start \
            --source-dir "${{ inputs.source_dir }}" \
            --test-level "$SF_TESTLEVEL" \
            --target-org "${{ inputs.sf_target_org }}" \
            --ignore-conflicts
          echo "DEPLOY_RESULT=CustomTestLevel:${SF_TESTLEVEL}" >> $GITHUB_ENV
      - name: Deploy without tests (default)
        if: env.SF_TESTLEVEL == '' || env.SF_TESTLEVEL == null
        run: |
          echo "Deploying ${{ inputs.source_dir }} with NoTestRun"
          sf project deploy start \
            --source-dir "${{ inputs.source_dir }}" \
            --test-level NoTestRun \
            --target-org "${{ inputs.sf_target_org }}" \
            --ignore-conflicts
          echo "DEPLOY_RESULT=NoTestRun" >> $GITHUB_ENV
      - name: Set deploy output
        id: deploy
        run: echo "deploy=${DEPLOY_RESULT}" >> $GITHUB_OUTPUT

  notify:
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: Notify devs
        uses: guidion-digital/slack-notifications@v1
        with:
          slack_channel: team-tectonic
          slack_token: ${{ secrets.SLACK_TOKEN }}
          workflow_status: ${{ needs.deploy.outputs.result }}
